\section{System Identification}
\subsection*{ARX Model}
We have chosen to represent the system in \textit{discrete time},
\begin{align}
    y_t &+ a_1 y_{t-1} + \cdots + a_n y_{t-p} = b_1 u_{t-1} + \cdots + b_q u_{t-q}
\end{align}

\begin{align}
    \theta = \begin{bmatrix}
    a_1, \ldots, a_p, b_1, \ldots, b_q
    \end{bmatrix}^T
\end{align} 

\begin{align}
    \varphi(t) = \begin{bmatrix}
    -y_{t-1} \cdots - y_{t-p}, u_{t-1} \cdots u_{t-q}
    \end{bmatrix}^T
\end{align}

\begin{align}
    y_t = \varphi^T_t \theta_t \quad  \forall t \in (1, N)
\end{align}



For a given system we can collect inputs and outputs over a time
interval $t$

\begin{align}
	\emph{Z}^N = \big \{u(t_0), y(t_0), \cdots, u(N), y(n)\big \}
\end{align}


\begin{align}
	\hat{\theta} = \arg\min_{x} \emph{V}_N(\theta) + \lambda(\theta - \theta^*)R(\theta - \theta^*)
\end{align}

The ARX(p, q) model is given by:
\begin{align}
y_t = \sum_{i=1}^p \varphi_i y_{t-i} + \sum_{j=1}^q \beta_j x_{t-j} + \epsilon_t
\end{align}


\subsection{Piecewise Linear function}

\begin{algorithm}
	\caption{Grouping Time Series Data by Bin Medians}
	\begin{algorithmic}[1]
	\REQUIRE Time series data \( y = \{y_1, y_2, \ldots, y_T\} \), excitation data \( u = \{u_1, u_2, \ldots, u_T\} \), bin size \( n \)
	\ENSURE Grouped data by bin medians
	
	\STATE Divide the time series \( y \) into bins of size \( n \)
	\FOR{$i = 1$ to $\left\lceil \frac{T}{n} \right\rceil$}
		\STATE $B_i \gets \{ y_{(i-1)n+1}, y_{(i-1)n+2}, \ldots, y_{\min(in, T)} \}$
		\STATE Compute the median \( m_i \) of the bin \( B_i \)
	\ENDFOR
	
	\STATE Group the data in \( y \) by their corresponding bin medians \( m_i \)
	
	\end{algorithmic}
	\end{algorithm}


	\section{Higher-Level MPC}
	\begin{subequations}\label{P2:FinalModel}
		\begin{align}
			\underset{\zeta, }{\text{min}}& \sum_{t=1}^{T} \Gamma \left\lVert E \right\rVert^{2}_{t} + \Lambda_t^T \sigma_t   \label{P2:0} \\
			&\hspace{-1em} \text{s.t.}  \quad \quad \forall \sigma_t \geq 0 \label{L1:0} \\
			& \qquad \zeta_{t} = \sum_{j=1}^3 \zeta_{t-1} \label{L1:1}  \\
			& \qquad h_{min}\leq h_{t} \leq h_{max}\label{L1:2}
			%& \qquad h_{min} \leq h \leq h_{l} + \sigma_{h_{r}} \label{L1:2}
	\end{align}
	\end{subequations}


\section{Lower-Level MPC}
\begin{subequations}\label{P2:FinalModel}
    \begin{align}
        \underset{\omega, E, P, Q_{\text{out}}}{\text{min}}& \sum_{k=1}^{h} \mathcal{Q} \left\lVert h_k - h_r \right\rVert^2 + \mathcal{R} \left\lVert \omega_k \right\rVert^2 + \Gamma \left\lVert E \right\rVert^{2}_{k} + \Lambda_k^T \sigma_k  \label{P2:0} \\
        &\hspace{-1em} \text{s.t.}  \quad \quad \forall \sigma_k \geq 0, \; l \geq 0 \label{P2:1} \\
		& \qquad Q_{\text{out}, k} = \sum_{j=1}^3 Q_{out_{j,k-1}} \label{P2:2} \\
        & \qquad E_{k} = \sum_{j=1}^3 E_{k-l} \label{P2:3}  \\
        & \qquad P_{k} = \sum_{j=1}^3 P_{k-l} \label{P2:4}  \\
        & \qquad Q_{in,k} = \tilde{Q}_{in,k-1} \label{P2:5}  \\
        & \qquad h_k = \frac{1}{A} \Big(\tilde{Q}_{in,k} - Q_{out,k}\Big) \label{P2:5} \\
		& \qquad \omega_{l} - \sigma_{\omega} \leq \omega_k \leq \omega_{u} + \sigma_{\omega} \label{P2:6} \\
		& \qquad P_{l} - \sigma_{P} \leq P_k \leq P_{u} + \sigma_{P} \label{P2:7} \\
		& \qquad h_{r} - \sigma_{h_{r}} \leq h_k \leq h_{l} + \sigma_{h_{r}} \label{P2:8}
\end{align}
\end{subequations}